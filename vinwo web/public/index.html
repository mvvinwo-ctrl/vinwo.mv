<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Bloomkraft ‚Äî Business Portal (MVR)</title>
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
  <!-- jsPDF for PDF generation -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <!-- Supabase client -->
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2.39.7/dist/umd/supabase-browser.min.js"></script>
  <style>
    :root{
      --turquoise: #2fb6ac;
      --coral: #ff7b6b;
      --bg: #fbfdfe;
      --card: #ffffff;
      --muted: #6b7280;
      --accent-text: #07303a;
      --success: #18a39e;
      --danger: #ff6b6b;
      --radius: 16px;
      --container-w: 1100px;
      --shadow: 0 8px 24px rgba(3, 20, 24, 0.08);
      --stat-bg: #f9fdfd;
      font-family: "Poppins", system-ui, -apple-system, "Segoe UI", Roboto, "Helvetica Neue", Arial;
    }

    html,body{
      height:100%;
      margin:0;
      background: linear-gradient(180deg, #f5fbfb, #fbfdfe);
      color: #0f1724;
    }

    .app{
      max-width: var(--container-w);
      margin: 24px auto;
      background: var(--card);
      border-radius: 20px;
      box-shadow: var(--shadow);
      overflow: hidden;
      display: none;
    }

    header{
      display:flex;
      align-items:center;
      gap:24px;
      background: linear-gradient(90deg, var(--turquoise), #37c6bf 70%);
      color: #fff;
      padding:20px 28px;
    }
    .logo{
      display:flex;
      align-items:center;
      gap:14px;
      font-weight:700;
      font-size:22px;
      letter-spacing:0.3px;
    }
    .nav{
      display:flex;
      gap:20px;
      margin-left:20px;
      align-items:center;
      font-weight:600;
      opacity:0.95;
    }
    .nav a{
      text-decoration:none;
      color: rgba(255,255,255,0.95);
      padding:8px 12px;
      border-radius:10px;
    }
    .nav a.active{ background: rgba(255,255,255,0.15); }

    .header-right{ margin-left:auto; display:flex; gap:14px; align-items:center; }

    main{
      display:flex;
      flex-direction: column;
      gap:28px;
      padding:28px;
    }

    .card{
      background: var(--card);
      border-radius: var(--radius);
      padding:22px;
      box-shadow: 0 4px 16px rgba(0,0,0,0.04);
      border: 1px solid rgba(0,0,0,0.03);
    }

    .big-stats{
      display:grid;
      grid-template-columns: repeat(auto-fit, minmax(240px, 1fr));
      gap:20px;
      width:100%;
    }
    .stat{
      background: var(--stat-bg);
      padding:24px;
      border-radius: var(--radius);
      text-align: center;
      border: 1px solid rgba(47,182,172,0.1);
    }
    .stat h4{ margin:0; color:var(--muted); font-weight:600; font-size:16px; }
    .stat .value{ margin-top:12px; font-size:32px; font-weight:800; color:var(--accent-text); }

    .chart-container {
      height: 120px;
      margin-top: 16px;
    }

    table{
      width:100%;
      border-collapse:collapse;
      font-size:15px;
    }
    thead th{
      text-align:left;
      padding:14px 12px;
      color:var(--muted);
      font-weight:700;
      border-bottom: 2px solid rgba(0,0,0,0.06);
    }
    tbody td{
      padding:14px 12px;
      border-bottom: 1px solid rgba(15,23,36,0.06);
      color:#0f1724;
    }
    tfoot td{
      padding:12px 12px;
      font-weight:700;
      background: var(--stat-bg);
      border-top: 2px solid rgba(0,0,0,0.08);
    }

    .page-title{
      font-size:36px;
      font-weight:800;
      margin:0 0 20px 0;
      color:var(--accent-text);
    }

    .controls{
      display:flex;
      gap:16px;
      align-items:center;
      margin-bottom:20px;
      flex-wrap:wrap;
    }
    .date-filters {
      display: flex;
      gap:12px;
      align-items: center;
      flex-wrap: wrap;
    }
    .date-filters label {
      font-weight:600;
      color: var(--muted);
      font-size:14px;
      white-space: nowrap;
    }
    .date-filters input[type="date"] {
      padding:8px 10px;
      border:1px solid #ddd;
      border-radius:8px;
      font-size:14px;
      background: #fff;
      min-width: 130px;
    }

    .btn{
      background:var(--turquoise);
      color:#fff;
      border:none;
      padding:10px 16px;
      border-radius:12px;
      cursor:pointer;
      font-weight:700;
      white-space:nowrap;
    }
    .btn.secondary{
      background:#f3f6f7;
      color: var(--accent-text);
      border:1px solid rgba(15,23,36,0.08);
    }
    .btn.danger{ 
      background:var(--coral); 
    }
    .btn.small {
      padding: 7px 12px;
      font-size: 13px;
      border-radius:10px;
    }

    @media (max-width: 980px){
      .app{ margin: 12px; }
      .controls{ flex-direction: column; align-items: stretch; }
      .date-filters{ justify-content: center; }
    }

    @media (max-width: 600px){
      .big-stats{ grid-template-columns: 1fr; }
      .nav{ gap:12px; font-size:14px; }
      .logo svg{ width:28px; height:28px; }
      .page-title{ font-size:28px; }
      .stat .value{ font-size:26px; }
      .date-filters{ flex-direction: column; align-items: stretch; }
      .date-filters label{
        display: block;
        margin-bottom: 4px;
      }
    }

    .modal-backdrop{
      position:fixed; inset:0; 
      background:rgba(4,12,17,0.4); 
      display:flex;
      align-items:center; 
      justify-content:center; 
      z-index:9999;
    }
    .modal{
      width:90%;
      max-width:420px;
      background:var(--card);
      padding:28px;
      border-radius:16px;
      box-shadow:0 20px 50px rgba(3,20,24,0.3);
      text-align: left;
    }
    .modal h2, .modal h3{
      margin-top:0; color: var(--accent-text);
    }
    .modal input,
    .modal select{
      width:100%;
      padding:12px;
      margin:10px 0 16px;
      border:1px solid #ddd;
      border-radius:10px;
      font-size:16px;
    }
    .modal .field{
      margin-bottom:12px;
    }
    .modal .field label{
      display:block;
      font-weight:600;
      margin-bottom:6px;
      color: var(--accent-text);
    }

    .muted{ color:var(--muted); font-weight:600; }
    .chip{ 
      display:inline-flex;
      align-items:center;
      padding:6px 12px; 
      border-radius:20px; 
      font-weight:700; 
      background:rgba(47,182,172,0.12); 
      color:var(--turquoise);
      font-size:14px;
    }

    .table-actions{ display:flex; gap:8px; }
    .empty-state {
      text-align: center;
      padding: 30px;
      color: var(--muted);
    }

    footer{ 
      padding:18px 28px; 
      font-size:13px; 
      color:var(--muted); 
      border-top:1px solid rgba(15,23,36,0.04); 
      text-align: center;
    }

    /* Hidden invoice canvas for PDF */
    #invoiceCanvas { display: none; }
  </style>
</head>
<body>

  <!-- LOGIN MODAL -->
  <div id="loginModal" class="modal-backdrop">
    <div class="modal">
      <h2>üîê Admin Login</h2>
      <p>Enter your 4-digit PIN to access Bloomkraft</p>
      <input type="password" id="loginPin" maxlength="4" inputmode="numeric" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢" autocomplete="off" />
      <div id="loginError" style="color:var(--danger); margin-top:8px; min-height:20px;"></div>
      <button class="btn" id="loginBtn" style="width:100%;">Login</button>
    </div>
  </div>

  <div class="app" id="mainApp" role="application" aria-label="Bloomkraft business portal">
    <header>
      <div class="logo" aria-hidden="true">
        <svg width="36" height="36" viewBox="0 0 24 24" fill="none" aria-hidden="true">
          <path d="M2 12C2 6.48 6.48 2 12 2c0 5.52 4.48 10 10 10-5.52 0-10 4.48-10 10C6.48 22 2 17.52 2 12z" fill="#fff" opacity="0.12"></path>
          <path d="M7.6 7.6c2.4 0 5.2 1.4 6.8 3.6 1.6 2.2 2 4.8 1.2 6.4-0.4 0.8-1 1.6-1.8 2.2-0.7-1-2-3-3.6-4.4C8.6 15.4 6.6 14 5.4 12.4 4 10.6 4 8.6 7.6 7.6z" fill="#fff"></path>
        </svg>
        Bloomkraft
      </div>

      <nav class="nav" role="navigation" aria-label="Main navigation">
        <a href="#" data-page="dashboard" class="active">Dashboard</a>
        <a href="#" data-page="income">Sale</a>
        <a href="#" data-page="expenses">Expenses</a>
      </nav>

      <div class="header-right">
        <div class="chip">MVR</div>
        <div style="color:#fff; font-weight:700;">Admin</div>
      </div>
    </header>

    <main id="content">

      <section id="page-dashboard" class="page" aria-hidden="false" style="display:block;">
        <h1 class="page-title">Overview</h1>
        <div class="controls">
          <div class="date-filters">
            <label>From: <input type="date" id="dashboardFrom" /></label>
            <label>To: <input type="date" id="dashboardTo" /></label>
            <button class="btn secondary" id="applyDashboardFilter">Apply</button>
            <button class="btn secondary" id="clearDashboardFilter">Clear</button>
          </div>
        </div>
        <div class="big-stats">
          <div class="stat card">
            <h4>Total Sale</h4>
            <div class="value" id="totalIncomeEl">MVR 0</div>
          </div>
          <div class="stat card">
            <h4>Total Expenses</h4>
            <div class="value" id="totalExpensesEl">MVR 0</div>
          </div>
          <div class="stat card">
            <h4>Net Profit</h4>
            <div class="value" id="netProfitEl">MVR 0</div>
          </div>
        </div>
        <div class="card" style="margin-top:24px;">
          <h4 class="muted" style="margin:0 0 12px;">Summary</h4>
          <div class="chart-container">
            <canvas id="summaryBarChart"></canvas>
          </div>
        </div>
      </section>

      <section id="page-income" class="page" aria-hidden="true" style="display:none;">
        <h1 class="page-title">Sale</h1>
        <div class="controls">
          <button class="btn" id="addIncomeBtn">+ Add Sale</button>
          <button class="btn secondary" id="exportIncomeCsv">Export CSV</button>
          <div class="date-filters">
            <label>From: <input type="date" id="incomeFrom" /></label>
            <label>To: <input type="date" id="incomeTo" /></label>
            <button class="btn secondary" id="applyIncomeFilter">Apply</button>
            <button class="btn secondary" id="clearIncomeFilter">Clear</button>
          </div>
        </div>
        <div class="card">
          <table id="incomeTable">
            <thead><tr><th>Date</th><th>Description</th><th>Payment</th><th>Amount (MVR)</th><th>Actions</th></tr></thead>
            <tbody></tbody>
            <tfoot><tr><td colspan="3"><strong>Total Sale</strong></td><td id="incomeTotalFooter">MVR 0</td><td></td></tr></tfoot>
          </table>
        </div>
      </section>

      <section id="page-expenses" class="page" aria-hidden="true" style="display:none;">
        <h1 class="page-title">Expenses</h1>
        <div class="controls">
          <button class="btn" id="addExpenseBtn">+ Add Expense</button>
          <button class="btn secondary" id="exportExpensesCsv">Export CSV</button>
          <div class="date-filters">
            <label>From: <input type="date" id="expensesFrom" /></label>
            <label>To: <input type="date" id="expensesTo" /></label>
            <button class="btn secondary" id="applyExpensesFilter">Apply</button>
            <button class="btn secondary" id="clearExpensesFilter">Clear</button>
          </div>
        </div>
        <div class="card">
          <table id="expensesTable">
            <thead><tr><th>Date</th><th>Description</th><th>Payment</th><th>Amount (MVR)</th><th>Actions</th></tr></thead>
            <tbody></tbody>
            <tfoot><tr><td colspan="3"><strong>Total Expenses</strong></td><td id="expensesTotalFooter">MVR 0</td><td></td></tr></tfoot>
          </table>
        </div>
      </section>

    </main>

    <footer>Bloomkraft ‚Ä¢ Business Portal ‚Äî Currency: MVR</footer>
  </div>

  <!-- Hidden canvas for PDF rendering -->
  <canvas id="invoiceCanvas" width="800" height="600"></canvas>

<script>
// ===== SUPABASE CONFIG =====
// üîë Replace these with your own Supabase project keys
const SUPABASE_URL = 'https://your-project.supabase.co';
const SUPABASE_ANON_KEY = 'your-anon-key-here';

// Initialize Supabase client
const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

// ===== LOGIN =====
const ADMIN_PIN = '5252';
function checkLogin() {
  if (sessionStorage.getItem('bloomkraft_logged_in') === 'true') {
    document.getElementById('loginModal').style.display = 'none';
    document.getElementById('mainApp').style.display = 'block';
    return true;
  }
  return false;
}

document.getElementById('loginBtn').addEventListener('click', attemptLogin);
document.getElementById('loginPin').addEventListener('keypress', e => { if (e.key === 'Enter') attemptLogin(); });

function attemptLogin() {
  const pin = document.getElementById('loginPin').value.trim();
  const err = document.getElementById('loginError');
  if (pin === ADMIN_PIN) {
    sessionStorage.setItem('bloomkraft_logged_in', 'true');
    document.getElementById('loginModal').style.display = 'none';
    document.getElementById('mainApp').style.display = 'block';
    init();
  } else {
    err.textContent = 'Incorrect PIN.';
    document.getElementById('loginPin').value = '';
  }
}

// ===== DATA FETCHING =====
let incomeRecords = [];
let expenseRecords = [];

async function loadAllData() {
  try {
    // Load sales
    let { data: sales, error: salesError } = await supabase
      .from('sales')
      .select('*')
      .order('date', { ascending: false });

    if (salesError) throw salesError;
    incomeRecords = sales.map(s => ({
      id: s.id,
      date: s.date,
      description: s.description,
      payment: s.payment,
      amount: parseFloat(s.amount)
    }));

    // Load expenses
    let { data: expenses, error: expensesError } = await supabase
      .from('expenses')
      .select('*')
      .order('date', { ascending: false });

    if (expensesError) throw expensesError;
    expenseRecords = expenses.map(e => ({
      id: e.id,
      date: e.date,
      description: e.description,
      payment: e.payment,
      amount: parseFloat(e.amount)
    }));

    // Render
    renderAll();
  } catch (err) {
    console.error('Failed to load data:', err);
    alert('Failed to load data from server. Check console.');
  }
}

// ===== RENDERING =====
function renderAll() {
  renderDashboard();
  renderIncome();
  renderExpenses();
}

// ===== UTILS =====
function formatMVR(n) {
  return (Number(n) || 0).toLocaleString('en-US', { minimumFractionDigits: 0, maximumFractionDigits: 2 }) + ' MVR';
}
function isInDateRange(dateStr, { from, to }) {
  if (!from && !to) return true;
  const d = new Date(dateStr);
  if (from && d < new Date(from)) return false;
  if (to && d > new Date(to)) return false;
  return true;
}

function computeTotals(filter = { from: '', to: '' }) {
  const inc = incomeRecords.filter(r => isInDateRange(r.date, filter));
  const exp = expenseRecords.filter(r => isInDateRange(r.date, filter));
  const totalIncome = inc.reduce((s, r) => s + r.amount, 0);
  const totalExpenses = exp.reduce((s, r) => s + r.amount, 0);
  return { totalIncome, totalExpenses, netProfit: totalIncome - totalExpenses };
}

// ===== CHART =====
let summaryBarChart = null;
function renderDashboard() {
  const filter = {
    from: document.getElementById('dashboardFrom').value,
    to: document.getElementById('dashboardTo').value
  };
  const { totalIncome, totalExpenses, netProfit } = computeTotals(filter);
  
  document.getElementById('totalIncomeEl').textContent = formatMVR(totalIncome);
  document.getElementById('totalExpensesEl').textContent = formatMVR(totalExpenses);
  const netEl = document.getElementById('netProfitEl');
  netEl.textContent = formatMVR(netProfit);
  netEl.style.color = netProfit >= 0 ? 'var(--success)' : 'var(--danger)';

  const ctx = document.getElementById('summaryBarChart')?.getContext('2d');
  if (ctx) {
    if (summaryBarChart) summaryBarChart.destroy();
    summaryBarChart = new Chart(ctx, {
      type: 'bar',
       {
        labels: ['Sale', 'Expenses'],
        datasets: [{
          label: 'Amount (MVR)',
           [totalIncome, totalExpenses],
          backgroundColor: ['#2fb6ac', '#ff6b6b'],
          borderWidth: 0,
          borderRadius: 6,
          borderSkipped: false
        }]
      },
      options: {
        responsive: true,
        maintainAspectRatio: false,
        plugins: {
          legend: { display: false },
          tooltip: {
            callbacks: {
              label: (context) => `${context.dataset.label}: ${formatMVR(context.parsed.y)}`
            }
          }
        },
        scales: {
          x: { grid: { display: false }, ticks: { color: 'var(--muted)' } },
          y: { beginAtZero: true, grid: { color: 'rgba(0,0,0,0.04)' }, ticks: { callback: (val) => val === 0 ? '0' : '', color: 'var(--muted)' } }
        }
      }
    });
  }
}

// ===== INCOME TABLE + INVOICE =====
function renderIncome() {
  const tbody = document.querySelector('#incomeTable tbody');
  const filter = { from: document.getElementById('incomeFrom')?.value, to: document.getElementById('incomeTo')?.value };
  const filtered = incomeRecords.filter(r => isInDateRange(r.date, filter));
  tbody.innerHTML = '';
  if (filtered.length === 0) {
    tbody.innerHTML = `<tr><td colspan="5" class="empty-state">No sale records</td></tr>`;
    document.getElementById('incomeTotalFooter').textContent = 'MVR 0';
    return;
  }
  filtered.forEach(r => {
    const tr = document.createElement('tr');
    tr.innerHTML = `
      <td>${r.date}</td>
      <td>${r.description}</td>
      <td>${r.payment}</td>
      <td style="color:var(--success)">${formatMVR(r.amount)}</td>
      <td class="table-actions">
        <button class="btn small secondary" onclick="downloadInvoice('${r.id}', '${r.date}', '${r.description}', '${r.payment}', ${r.amount})">Invoice</button>
        <button class="btn small secondary" onclick="openEditIncomeModal('${r.id}', '${r.date}', '${r.description}', '${r.payment}', ${r.amount})">Edit</button>
        <button class="btn small danger" onclick="deleteIncome('${r.id}')">Delete</button>
      </td>
    `;
    tbody.appendChild(tr);
  });
  const total = filtered.reduce((s, r) => s + r.amount, 0);
  document.getElementById('incomeTotalFooter').textContent = formatMVR(total);
}

// ===== PDF INVOICE GENERATION =====
async function downloadInvoice(id, date, desc, payment, amount) {
  const { jsPDF } = window.jspdf;
  const doc = new jsPDF();

  // Header
  doc.setFontSize(24);
  doc.setTextColor(7, 48, 58);
  doc.text("Bloomkraft", 20, 20);
  doc.setFontSize(12);
  doc.setTextColor(107, 114, 128);
  doc.text(`Invoice #INV-${id.substring(0, 8).toUpperCase()}`, 160, 20);

  // Info
  doc.setFontSize(12);
  doc.setTextColor(0, 0, 0);
  doc.text(`Date: ${date}`, 20, 40);
  doc.text(`Description: ${desc}`, 20, 46);
  doc.text(`Payment: ${payment}`, 20, 52);

  // Table
  doc.setFontSize(12);
  doc.setFillColor(249, 253, 253);
  doc.rect(20, 65, 170, 10, 'F');
  doc.setTextColor(107, 114, 128);
  doc.text("Description", 25, 72);
  doc.text("Amount (MVR)", 160, 72);

  doc.setTextColor(0, 0, 0);
  doc.text(desc, 25, 85);
  doc.text(formatMVR(amount).replace(' MVR', ''), 160, 85);

  // Total
  doc.setFontSize(16);
  doc.setFont("helvetica", "bold");
  doc.text("Total:", 120, 105);
  doc.text(formatMVR(amount).replace(' MVR', ''), 160, 105);

  // Footer
  doc.setFontSize(10);
  doc.setTextColor(107, 114, 128);
  doc.text("Thank you for your business!", 20, 130);
  doc.text("Currency: MVR ‚Ä¢ Bloomkraft Portal", 20, 135);

  // Save
  doc.save(`invoice-${id}.pdf`);
}

// ===== EXPENSES =====
function renderExpenses() {
  const tbody = document.querySelector('#expensesTable tbody');
  const filter = { from: document.getElementById('expensesFrom')?.value, to: document.getElementById('expensesTo')?.value };
  const filtered = expenseRecords.filter(r => isInDateRange(r.date, filter));
  tbody.innerHTML = '';
  if (filtered.length === 0) {
    tbody.innerHTML = `<tr><td colspan="5" class="empty-state">No expense records</td></tr>`;
    document.getElementById('expensesTotalFooter').textContent = 'MVR 0';
    return;
  }
  filtered.forEach(r => {
    const tr = document.createElement('tr');
    tr.innerHTML = `
      <td>${r.date}</td>
      <td>${r.description}</td>
      <td>${r.payment}</td>
      <td style="color:var(--danger)">${formatMVR(r.amount)}</td>
      <td class="table-actions">
        <button class="btn small secondary" onclick="openEditExpenseModal('${r.id}', '${r.date}', '${r.description}', '${r.payment}', ${r.amount})">Edit</button>
        <button class="btn small danger" onclick="deleteExpense('${r.id}')">Delete</button>
      </td>
    `;
    tbody.appendChild(tr);
  });
  const total = filtered.reduce((s, r) => s + r.amount, 0);
  document.getElementById('expensesTotalFooter').textContent = formatMVR(total);
}

// ===== CRUD OPERATIONS =====
async function addSale(date, desc, payment, amount) {
  const { error } = await supabase.from('sales').insert([{ date, description: desc, payment, amount }]);
  if (error) throw error;
}

async function updateSale(id, date, desc, payment, amount) {
  const { error } = await supabase.from('sales').update({ date, description: desc, payment, amount }).eq('id', id);
  if (error) throw error;
}

async function deleteSale(id) {
  const { error } = await supabase.from('sales').delete().eq('id', id);
  if (error) throw error;
}

async function addExpense(date, desc, payment, amount) {
  const { error } = await supabase.from('expenses').insert([{ date, description: desc, payment, amount }]);
  if (error) throw error;
}

async function updateExpense(id, date, desc, payment, amount) {
  const { error } = await supabase.from('expenses').update({ date, description: desc, payment, amount }).eq('id', id);
  if (error) throw error;
}

async function deleteExpense(id) {
  const { error } = await supabase.from('expenses').delete().eq('id', id);
  if (error) throw error;
}

// ===== MODALS & HANDLERS =====
function openEditIncomeModal(id, date, desc, payment, amount) {
  const modal = document.createElement('div');
  modal.className = 'modal-backdrop';
  modal.innerHTML = `
    <div class="modal">
      <button style="float:right; background:none; border:none; font-size:20px; cursor:pointer;" onclick="this.parentElement.parentElement.remove()">‚úï</button>
      <h3>Edit Sale</h3>
      <div class="field"><label>Date</label><input type="date" id="m_date" value="${date}"></div>
      <div class="field"><label>Description</label><input id="m_desc" value="${desc}"></div>
      <div class="field"><label>Payment</label>
        <select id="m_pay">
          <option value="Cash" ${payment === 'Cash' ? 'selected' : ''}>Cash</option>
          <option value="Transfer" ${payment === 'Transfer' ? 'selected' : ''}>Transfer</option>
        </select>
      </div>
      <div class="field"><label>Amount (MVR)</label><input type="number" id="m_amt" value="${amount}" step="0.01"></div>
      <div style="display:flex; gap:10px; justify-content:flex-end; margin-top:16px;">
        <button class="btn secondary" onclick="this.parentElement.parentElement.parentElement.remove()">Cancel</button>
        <button class="btn" onclick="saveIncome('${id}')">Save</button>
      </div>
    </div>
  `;
  document.body.appendChild(modal);
}

async function saveIncome(id) {
  const date = document.getElementById('m_date').value;
  const desc = document.getElementById('m_desc').value;
  const payment = document.getElementById('m_pay').value;
  const amount = parseFloat(document.getElementById('m_amt').value) || 0;
  
  if (id === 'new') {
    await addSale(date, desc, payment, amount);
  } else {
    await updateSale(id, date, desc, payment, amount);
  }
  document.querySelector('.modal-backdrop').remove();
  await loadAllData(); // auto-refresh
}

async function deleteIncome(id) {
  if (confirm('Delete this sale?')) {
    await deleteSale(id);
    await loadAllData();
  }
}

function openEditExpenseModal(id, date, desc, payment, amount) {
  const modal = document.createElement('div');
  modal.className = 'modal-backdrop';
  modal.innerHTML = `
    <div class="modal">
      <button style="float:right; background:none; border:none; font-size:20px; cursor:pointer;" onclick="this.parentElement.parentElement.remove()">‚úï</button>
      <h3>Edit Expense</h3>
      <div class="field"><label>Date</label><input type="date" id="m_date" value="${date}"></div>
      <div class="field"><label>Description</label><input id="m_desc" value="${desc}"></div>
      <div class="field"><label>Payment</label>
        <select id="m_pay">
          <option value="Cash" ${payment === 'Cash' ? 'selected' : ''}>Cash</option>
          <option value="Transfer" ${payment === 'Transfer' ? 'selected' : ''}>Transfer</option>
        </select>
      </div>
      <div class="field"><label>Amount (MVR)</label><input type="number" id="m_amt" value="${amount}" step="0.01"></div>
      <div style="display:flex; gap:10px; justify-content:flex-end; margin-top:16px;">
        <button class="btn secondary" onclick="this.parentElement.parentElement.parentElement.remove()">Cancel</button>
        <button class="btn" onclick="saveExpense('${id}')">Save</button>
      </div>
    </div>
  `;
  document.body.appendChild(modal);
}

async function saveExpense(id) {
  const date = document.getElementById('m_date').value;
  const desc = document.getElementById('m_desc').value;
  const payment = document.getElementById('m_pay').value;
  const amount = parseFloat(document.getElementById('m_amt').value) || 0;
  
  if (id === 'new') {
    await addExpense(date, desc, payment, amount);
  } else {
    await updateExpense(id, date, desc, payment, amount);
  }
  document.querySelector('.modal-backdrop').remove();
  await loadAllData();
}

async function deleteExpense(id) {
  if (confirm('Delete this expense?')) {
    await deleteExpense(id);
    await loadAllData();
  }
}

// ===== ADD BUTTONS =====
document.getElementById('addIncomeBtn')?.addEventListener('click', () => {
  const modal = document.createElement('div');
  modal.className = 'modal-backdrop';
  modal.innerHTML = `
    <div class="modal">
      <button style="float:right; background:none; border:none; font-size:20px; cursor:pointer;" onclick="this.parentElement.parentElement.remove()">‚úï</button>
      <h3>Add Sale</h3>
      <div class="field"><label>Date</label><input type="date" id="m_date" value="${new Date().toISOString().slice(0,10)}"></div>
      <div class="field"><label>Description</label><input id="m_desc" placeholder="e.g. Product Sale"></div>
      <div class="field"><label>Payment</label>
        <select id="m_pay"><option>Cash</option><option>Transfer</option></select>
      </div>
      <div class="field"><label>Amount (MVR)</label><input type="number" id="m_amt" value="0" step="0.01"></div>
      <div style="display:flex; gap:10px; justify-content:flex-end; margin-top:16px;">
        <button class="btn secondary" onclick="this.parentElement.parentElement.parentElement.remove()">Cancel</button>
        <button class="btn" onclick="saveIncome('new')">Add</button>
      </div>
    </div>
  `;
  document.body.appendChild(modal);
});

document.getElementById('addExpenseBtn')?.addEventListener('click', () => {
  const modal = document.createElement('div');
  modal.className = 'modal-backdrop';
  modal.innerHTML = `
    <div class="modal">
      <button style="float:right; background:none; border:none; font-size:20px; cursor:pointer;" onclick="this.parentElement.parentElement.remove()">‚úï</button>
      <h3>Add Expense</h3>
      <div class="field"><label>Date</label><input type="date" id="m_date" value="${new Date().toISOString().slice(0,10)}"></div>
      <div class="field"><label>Description</label><input id="m_desc" placeholder="e.g. Office Supplies"></div>
      <div class="field"><label>Payment</label>
        <select id="m_pay"><option>Cash</option><option>Transfer</option></select>
      </div>
      <div class="field"><label>Amount (MVR)</label><input type="number" id="m_amt" value="0" step="0.01"></div>
      <div style="display:flex; gap:10px; justify-content:flex-end; margin-top:16px;">
        <button class="btn secondary" onclick="this.parentElement.parentElement.parentElement.remove()">Cancel</button>
        <button class="btn" onclick="saveExpense('new')">Add</button>
      </div>
    </div>
  `;
  document.body.appendChild(modal);
});

// ===== EXPORT =====
function exportCsv(filename, headers, records) {
  const csv = [headers, ...records.map(r => [r.date, r.description, r.payment, r.amount])]
    .map(row => row.map(String).map(cell => cell.includes(',') ? `"${cell}"` : cell).join(','))
    .join('\n');
  const blob = new Blob([csv], { type: 'text/csv' });
  const url = URL.createObjectURL(blob);
  const a = document.createElement('a');
  a.href = url;
  a.download = filename;
  a.click();
  URL.revokeObjectURL(url);
}

document.getElementById('exportIncomeCsv')?.addEventListener('click', () => exportCsv('sale.csv', ['Date','Description','Payment','Amount'], incomeRecords));
document.getElementById('exportExpensesCsv')?.addEventListener('click', () => exportCsv('expenses.csv', ['Date','Description','Payment','Amount'], expenseRecords));

// ===== NAVIGATION =====
document.querySelectorAll('.nav a').forEach(a => {
  a.addEventListener('click', e => {
    e.preventDefault();
    document.querySelectorAll('.nav a').forEach(x => x.classList.remove('active'));
    a.classList.add('active');
    document.querySelectorAll('.page').forEach(sec => {
      sec.style.display = sec.id === `page-${a.dataset.page}` ? 'block' : 'none';
    });
  });
});

// ===== FILTERS =====
['dashboard','income','expenses'].forEach(p => {
  const applyBtn = document.getElementById(`apply${p.charAt(0).toUpperCase() + p.slice(1)}Filter`);
  const clearBtn = document.getElementById(`clear${p.charAt(0).toUpperCase() + p.slice(1)}Filter`);
  if (applyBtn) applyBtn.addEventListener('click', () => {
    if(p==='dashboard') renderDashboard();
    else if(p==='income') renderIncome();
    else renderExpenses();
  });
  if (clearBtn) clearBtn.addEventListener('click', () => {
    document.getElementById(`${p}From`).value = '';
    document.getElementById(`${p}To`).value = '';
    if(p==='dashboard') renderDashboard();
    else if(p==='income') renderIncome();
    else renderExpenses();
  });
});

// ===== AUTO REFRESH =====
function setupAutoRefresh() {
  setInterval(loadAllData, 30000); // every 30 seconds
}

// ===== INIT =====
async function init() {
  await loadAllData();
  setupAutoRefresh();
}

if (!checkLogin()) {
  document.getElementById('loginModal').style.display = 'flex';
}
</script>
</body>
</html>
