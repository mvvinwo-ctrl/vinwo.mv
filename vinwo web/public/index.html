<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Bloomkraft ‚Äî Business Portal (MVR)</title>
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2.39.7/dist/umd/supabase-browser.min.js"></script>
  <style>
    :root{
      --turquoise: #2fb6ac;
      --coral: #ff7b6b;
      --bg: #fbfdfe;
      --card: #ffffff;
      --muted: #6b7280;
      --accent-text: #07303a;
      --success: #18a39e;
      --danger: #ff6b6b;
      --radius: 16px;
      --container-w: 1100px;
      --shadow: 0 8px 24px rgba(3, 20, 24, 0.08);
      --stat-bg: #f9fdfd;
      font-family: "Poppins", system-ui, -apple-system, "Segoe UI", Roboto, "Helvetica Neue", Arial;
    }
    html,body{ height:100%; margin:0; background: linear-gradient(180deg, #f5fbfb, #fbfdfe); color: #0f1724; }
    .app{ max-width: var(--container-w); margin: 24px auto; background: var(--card); border-radius: 20px; box-shadow: var(--shadow); overflow: hidden; display: none; }
    .modal-backdrop{ position:fixed; inset:0; background:rgba(4,12,17,0.4); display:flex; align-items:center; justify-content:center; z-index:9999; }
    .modal{ width:90%; max-width:420px; background:var(--card); padding:28px; border-radius:16px; box-shadow:0 20px 50px rgba(3,20,24,0.3); }
    .btn{ background:var(--turquoise); color:#fff; border:none; padding:10px 16px; border-radius:12px; cursor:pointer; font-weight:700; width:100%; margin-top:12px; }
    #loginError{ color: var(--danger); margin-top:8px; min-height:20px; }
  </style>
</head>
<body>

  <div id="loginModal" class="modal-backdrop">
    <div class="modal">
      <h2>üîê Admin Login</h2>
      <p>Enter your 4-digit PIN to access Bloomkraft</p>
      <input type="password" id="loginPin" maxlength="4" inputmode="numeric" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢" autocomplete="off" autofocus />
      <div id="loginError"></div>
      <button class="btn" id="loginBtn">Login</button>
    </div>
  </div>

  <div class="app" id="mainApp">
    <div style="padding:30px; text-align:center;">
      <h2>Welcome to Bloomkraft!</h2>
      <p>You are logged in.</p>
    </div>
  </div>

<script>
// üîë Supabase Config
const SUPABASE_URL = 'https://skejswjowceevzkloiog.supabase.co';
const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InNrZWpzd2pvd2NlZXZ6a2xvaW9nIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjEwNDg0NDYsImV4cCI6MjA3NjYyNDQ0Nn0.Q9LSKeEkOO7FZv3SOKvJa8efksRfGFYrvZDKlQmKTqk';
const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

const ADMIN_PIN = '5252';

// ‚úÖ SAFE LOGIN SETUP
function setupLogin() {
  const loginBtn = document.getElementById('loginBtn');
  const pinInput = document.getElementById('loginPin');
  
  if (!loginBtn || !pinInput) return;

  loginBtn.onclick = attemptLogin;
  pinInput.onkeypress = (e) => { if (e.key === 'Enter') attemptLogin(); };
}

function attemptLogin() {
  const pin = document.getElementById('loginPin').value.trim();
  const err = document.getElementById('loginError');
  if (pin === ADMIN_PIN) {
    sessionStorage.setItem('bloomkraft_logged_in', 'true');
    document.getElementById('loginModal').style.display = 'none';
    document.getElementById('mainApp').style.display = 'block';
  } else {
    err.textContent = 'Incorrect PIN.';
    document.getElementById('loginPin').value = '';
  }
}

// ‚úÖ FIXED: Correct Supabase destructuring
async function loadAllData() {
  try {
    // ‚úÖ Use "data: sales", NOT " sales"
    const { data: sales, error: salesErr } = await supabase
      .from('sales')
      .select('*')
      .order('date', { ascending: false });
    if (salesErr) throw salesErr;
    console.log('Sales loaded:', sales.length);

    const { data: expenses, error: expErr } = await supabase
      .from('expenses')
      .select('*')
      .order('date', { ascending: false });
    if (expErr) throw expErr;
    console.log('Expenses loaded:', expenses.length);

    // Optional: render dashboard, etc.
  } catch (err) {
    console.error('Error loading data:', err.message);
  }
}

// üöÄ INIT
document.addEventListener('DOMContentLoaded', () => {
  // Always set up login first
  setupLogin();

  // Check if already logged in
  if (sessionStorage.getItem('bloomkraft_logged_in') === 'true') {
    document.getElementById('loginModal').style.display = 'none';
    document.getElementById('mainApp').style.display = 'block';
    loadAllData(); // Only load data after login
  }
});
</script>
</body>
</html>
